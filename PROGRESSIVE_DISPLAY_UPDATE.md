# 段階的表示機能の実装

## 概要
ユーザーが分析結果を待つ時間を短縮するため、分析プロセスを段階的に表示する機能を実装しました。

## 主な変更点

### 1. 契約書分析の段階的表示

新しい関数 `analyze_contract_step_by_step()` を実装し、以下のステップごとに結果を表示：

1. **ステップ1: 契約情報の抽出** 📝
   - 品目名、仕向地、需要者、用途、契約金額、納期

2. **ステップ2-A: EAR対象品目の判定** 🔍
   - 米国原産品の可能性
   - 米国製品の組込品の可能性
   - 外国直接製品（FDP）ルールの該当性

3. **ステップ2-B: ECCN番号の判定** 🔢
   - eccnnumber.jsonから詳細な分析
   - 推定ECCN番号（5桁）
   - カテゴリー、グループ、規制理由
   - 選定理由の詳細説明

4. **ステップ2-C: カントリーチャート分析** 🗺️
   - 11_12_2025_country_chart_export.csvから詳細な分析
   - 仕向国に対する規制理由ごとの許可要否
   - 「X」マークの確認

5. **ステップ2-D: 許可例外の検討** 📋
   - LVS, GBS, TSR, TMP, ENC等の適用可能性

6. **ステップ2-E: 禁輸国・リスト規制** 🚨
   - DPL、Entity List、禁輸国のチェック

7. **ステップ3: 総合判定とリスク評価** 📊
   - リスクレベル（高/中/低）
   - 許可申請の要否
   - 推奨アクション

8. **ステップ4: 必要な手続き** 📝
   - BISへの申請手順

### 2. チャット相談の段階的表示

新しい関数 `analyze_chat_step_by_step()` を実装：

1. **ステップ1: ECCN番号判定** 🔢
2. **ステップ2: カントリーチャート分析** 🗺️
3. **ステップ3: General Prohibitions確認** 🚨
4. **ステップ4: 総合判定とリスク評価** 📊
5. **ステップ5: RAG許可例外判定** 🎯

## 技術的な実装

### st.container()の活用
```python
result_container = st.container()
```
各ステップの結果を動的に表示するためのコンテナを作成

### st.spinner()での進捗表示
```python
with st.spinner("📝 ステップ1: 契約情報を抽出中..."):
    # 処理
```
各ステップの実行中にスピナーを表示してユーザーに進捗を伝達

### 段階的なLLM呼び出し
各ステップごとに個別のLLM呼び出しを実行し、結果が出次第表示：
- トークン数を抑えたプロンプト設計
- 各ステップに特化した分析指示

## ユーザーエクスペリエンスの向上

### Before（以前）
- 全ての分析が終わるまで待つ必要があった
- 分析中に何が起こっているか不明
- 長い待ち時間でユーザーが不安

### After（改善後）
- ✅ 各ステップの結果を即座に表示
- ✅ 進捗が視覚的に分かりやすい
- ✅ 待ち時間が短く感じられる
- ✅ どの段階で何を分析しているか明確

## 利点

1. **体感速度の向上**: 結果が段階的に表示されるため、全体の処理時間は同じでも速く感じる
2. **透明性の向上**: 各ステップで何を分析しているかが明確
3. **エラーハンドリングの改善**: 特定のステップで問題が発生した場合、そこまでの結果は表示される
4. **ユーザーの理解促進**: 分析プロセスが可視化され、判定根拠が理解しやすい

## 注意事項

- 各ステップのプロンプトは簡潔にして、トークン数を抑制
- エラーが発生してもそれまでの結果は表示される
- セッション状態に最終結果を保存し、ダウンロード機能も維持

## 今後の改善案

- [ ] 各ステップの実行時間を計測して表示
- [ ] ユーザーが特定のステップをスキップできる機能
- [ ] 各ステップの結果をキャッシュして再分析を高速化
- [ ] ストリーミング形式での結果表示

